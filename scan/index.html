<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Сканер билетов</title>
  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b1320; color:#e5e7eb; }
    header { padding:12px 16px; border-bottom:1px solid #1f2937; }
    main { padding:16px; max-width:720px; margin:0 auto; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
    select, input { padding:10px 12px; border-radius:10px; border:1px solid #334155; background:#0f172a; color:#e5e7eb; }
    button { padding:10px 14px; border-radius:10px; border:1px solid #334155; background:#111827; color:#e5e7eb; cursor:pointer; }
    video { width:100%; max-height:440px; background:#000; border-radius:12px; border:1px solid #1f2937; }
    .status { margin-top:12px; padding:12px; border-radius:10px; border:1px solid #374151; background:#0f172a; }
    .ok { border-color:#065f46; color:#d1fae5; }
    .bad{ border-color:#7f1d1d; color:#fee2e2; }
  </style>
</head>
<body>
  <header><strong>Сканер билетов</strong></header>
  <main>
    <div class="row">
      <label>Камера:</label>
      <select id="camera"></select>
      <button id="reload">Запустить</button>
    </div>

    <video id="preview" playsinline autoplay muted></video>

    <div class="row" style="margin-top:12px">
      <input id="manual" placeholder="Вставьте резервный код вручную" style="flex:1;min-width:260px">
      <button id="check">Проверить код</button>
    </div>

    <div id="msg" class="status">Готово. Нажмите «Запустить» и дайте доступ к камере.</div>

    <!-- Карточка с данными билета -->
    <div id="card" style="display:none;margin-top:12px;padding:12px;border:1px solid #374151;border-radius:10px;background:#0f172a;">
      <div style="font-weight:600" id="card-title">—</div>
      <div style="margin-top:6px;font-size:14px;opacity:.9" id="card-meta">—</div>
    </div>
  </main>

  <script type="module">
    import { BrowserMultiFormatReader } from 'https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/+esm';

    const reader = new BrowserMultiFormatReader();
    const camSel = document.getElementById('camera');
    const video  = document.getElementById('preview');
    const msgEl  = document.getElementById('msg');

    video.setAttribute('playsinline','');
    video.setAttribute('autoplay','');
    video.setAttribute('muted','');

    function setMsg(t, ok) {
      msgEl.className = 'status ' + (ok===true ? 'ok' : ok===false ? 'bad' : '');
      msgEl.textContent = t;
    }

    function showCard(data, ok) {
      const card  = document.getElementById('card');
      const title = document.getElementById('card-title');
      const meta  = document.getElementById('card-meta');

      if (!data) { card.style.display = 'none'; return; }

      title.textContent = (data.name || 'Гость');
      title.style.color = ok ? '#34d399' : '#fca5a5';

      const parts = [];
      // if (data.type) parts.push(`Тип: ${data.type}`);
      if (data.order_id) parts.push(`Заказ: ${data.order_id}`);
      if (data.used) parts.push(`Статус: уже использован${data.used_at ? ' (' + new Date(data.used_at).toLocaleString() + ')' : ''}`);
      meta.textContent = parts.join(' · ');

      card.style.display = 'block';
    }

    async function ensurePermission() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: 'environment' } },
          audio: false
        });
        stream.getTracks().forEach(t => t.stop());
      } catch (e) {
        console.warn('getUserMedia failed:', e);
      }
    }

    async function listCams() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const videos  = devices.filter(d => d.kind === 'videoinput');
      camSel.innerHTML = '';
      for (const d of videos) {
        const o = document.createElement('option');
        o.value = d.deviceId;
        o.textContent = d.label || `Камера ${camSel.length + 1}`;
        camSel.appendChild(o);
      }
      const prefer = Array.from(camSel.options).find(o => /rear|back|environment/i.test(o.textContent));
      if (prefer) camSel.value = prefer.value;
      if (videos.length === 0) {
        const o = document.createElement('option');
        o.textContent = 'Нет камеры';
        camSel.appendChild(o);
      }
    }

    async function startSelected() {
      await reader.reset();
      const id = camSel.value || null;
      try {
        await reader.decodeFromVideoDevice(id, video, async (r, err) => {
          if (r) {
            await reader.reset();
            await validate(r.getText());
            setTimeout(startSelected, 800);
          }
        });
        setMsg('Наведите камеру на QR…', true);
      } catch (e) {
        console.error(e);
        setMsg('Не удалось открыть камеру. Разрешите доступ к камере в браузере.', false);
      }
    }

    async function validate(token) {
      try {
        const r = await fetch('/api/validate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token })
        });
        const d = await r.json();

        if (d.ok) {
          setMsg(`OK — ${d.name || 'Гость'}${d.type ? ' · ' + d.type : ''}`, true);
          showCard(d, true);
        } else {
          const text = d.error === 'ALREADY_USED'
            ? `УЖЕ ИСПОЛЬЗОВАН — ${d.name || 'Гость'}${d.type ? ' · ' + d.type : ''}`
            : `ОШИБКА — ${d.error || 'неизвестно'}`;
          setMsg(text, false);
          showCard(d, false);
        }
      } catch (e) {
        setMsg('Сеть недоступна', false);
        showCard(null, false);
      }
    }

    document.getElementById('reload').onclick = async () => {
      await ensurePermission();
      await listCams();
      await startSelected();
    };

    document.getElementById('check').onclick = () => {
      const t = document.getElementById('manual').value.trim();
      if (t) validate(t);
    };

    // автозапуск после первого клика (iOS)
    document.addEventListener('click', async function once() {
      document.removeEventListener('click', once);
      await ensurePermission();
      await listCams();
      await startSelected();
    });
  </script>
</body>
</html>
